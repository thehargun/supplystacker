<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Inventory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header h1 {
            font-size: 28px;
            color: #2c3e50;
        }
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .header-buttons a {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s;
        }
        .header-buttons a:hover { background-color: #2980b9; }
        .header-buttons a.secondary {
            background-color: #2c3e50;
        }
        .header-buttons a.secondary:hover { background-color: #1a252f; }
        
        .search-bar {
            margin-bottom: 20px;
        }
        .search-bar input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 2px solid #dce4ec;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        .search-bar input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        /* Desktop Table View */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            user-select: text;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #7f8c8d;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr:hover { background-color: #f8f9fa; }
        .item-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            background: #f0f0f0;
        }
        .qty-input {
            width: 70px;
            padding: 8px 10px;
            border: 2px solid #dce4ec;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s;
        }
        .qty-input:focus {
            outline: none;
            border-color: #3498db;
            background: #e8f4fc;
        }
        .qty-input.saving {
            border-color: #f39c12;
            background: #fef9e7;
        }
        .qty-input.saved {
            border-color: #27ae60;
            background: #e8f8f5;
        }
        .actions {
            display: flex;
            gap: 8px;
        }
        .actions a {
            padding: 8px 14px;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-edit { background: #27ae60; color: white; }
        .btn-edit:hover { background: #219a52; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-delete:hover { background: #c0392b; }
        .dragging { background-color: #e8f4fc !important; opacity: 0.8; }
        .drag-over { border-top: 3px solid #3498db; }
        
        /* Drag Handle */
        .drag-handle {
            cursor: grab;
            color: #bdc3c7;
            font-size: 18px;
            padding: 5px 10px;
            user-select: none;
            transition: color 0.2s;
        }
        .drag-handle:hover {
            color: #7f8c8d;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        
        /* Mobile Card View */
        .mobile-list { display: none; }
        .mobile-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .mobile-card-header {
            display: flex;
            align-items: center;
            padding: 14px;
            gap: 14px;
            cursor: pointer;
        }
        .mobile-card-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            background: #f0f0f0;
            flex-shrink: 0;
        }
        .mobile-card-name {
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
            font-size: 15px;
        }
        .mobile-card-toggle {
            color: #bdc3c7;
            font-size: 20px;
            transition: transform 0.3s;
        }
        .mobile-card.expanded .mobile-card-toggle {
            transform: rotate(180deg);
        }
        .mobile-card-details {
            display: none;
            padding: 0 14px 14px 14px;
            border-top: 1px solid #ecf0f1;
        }
        .mobile-card.expanded .mobile-card-details {
            display: block;
        }
        .mobile-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
            align-items: center;
        }
        .mobile-detail-row:last-child { border-bottom: none; }
        .mobile-detail-label {
            color: #7f8c8d;
            font-size: 13px;
        }
        .mobile-detail-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        .mobile-qty-input {
            width: 70px;
            padding: 8px 10px;
            border: 2px solid #dce4ec;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }
        .mobile-qty-input:focus {
            outline: none;
            border-color: #3498db;
        }
        .mobile-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }
        .mobile-actions a {
            flex: 1;
            padding: 12px;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        @media (max-width: 900px) {
            .table-container { display: none; }
            .mobile-list { display: block; }
            .header h1 { font-size: 22px; }
            .header-buttons a { padding: 10px 16px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Inventory (<%= inventory.length %> items)</h1>
            <div class="header-buttons">
                <a href="/admin/add-inventory">+ Add Item</a>
                <a href="/admin" class="secondary">Back to Admin</a>
            </div>
        </div>
        
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search inventory by name...">
        </div>
        
        <!-- Desktop Table View -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:40px"></th>
                        <th>Image</th>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Cost</th>
                        <th>Quantity</th>
                        <th>PL1</th>
                        <th>PL2</th>
                        <th>PL3</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryList">
                    <% inventory.forEach(item => { %>
                        <tr class="inventory-item" data-id="<%= item.id %>" data-category="<%= item.itemCategory %>">
                            <td><span class="drag-handle" draggable="true" title="Drag to reorder">☰</span></td>
                            <td><img src="<%= item.imageUrl %>" alt="" class="item-img"></td>
                            <td><strong><%= item.itemName %></strong></td>
                            <td><%= item.itemCategory || '-' %></td>
                            <td>$<%= item.cost ? item.cost.toFixed(2) : '0.00' %></td>
                            <td>
                                <input type="number" class="qty-input" value="<%= item.quantity %>" data-id="<%= item.id %>" min="0">
                            </td>
                            <td>$<%= item.priceLevel1 ? item.priceLevel1.toFixed(2) : '0.00' %></td>
                            <td>$<%= item.priceLevel2 ? item.priceLevel2.toFixed(2) : '0.00' %></td>
                            <td>$<%= item.priceLevel3 ? item.priceLevel3.toFixed(2) : '0.00' %></td>
                            <td class="actions">
                                <a href="/admin/edit-inventory/<%= item.id %>" class="btn-edit">Edit</a>
                                <a href="/admin/delete-inventory/<%= item.id %>" class="btn-delete" onclick="return confirm('Delete this item?');">Delete</a>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        
        <!-- Mobile Card View -->
        <div class="mobile-list">
            <% inventory.forEach(item => { %>
                <div class="mobile-card" data-id="<%= item.id %>">
                    <div class="mobile-card-header">
                        <img src="<%= item.imageUrl %>" alt="" class="mobile-card-img">
                        <span class="mobile-card-name"><%= item.itemName %></span>
                        <span class="mobile-card-toggle">▼</span>
                    </div>
                    <div class="mobile-card-details">
                        <div class="mobile-detail-row">
                            <span class="mobile-detail-label">Category</span>
                            <span class="mobile-detail-value"><%= item.itemCategory || '-' %></span>
                        </div>
                        <div class="mobile-detail-row">
                            <span class="mobile-detail-label">Cost</span>
                            <span class="mobile-detail-value">$<%= item.cost ? item.cost.toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="mobile-detail-row">
                            <span class="mobile-detail-label">Quantity</span>
                            <input type="number" class="mobile-qty-input qty-input" value="<%= item.quantity %>" data-id="<%= item.id %>" min="0">
                        </div>
                        <div class="mobile-detail-row">
                            <span class="mobile-detail-label">Price Level 1</span>
                            <span class="mobile-detail-value">$<%= item.priceLevel1 ? item.priceLevel1.toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="mobile-detail-row">
                            <span class="mobile-detail-label">Price Level 2</span>
                            <span class="mobile-detail-value">$<%= item.priceLevel2 ? item.priceLevel2.toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="mobile-detail-row">
                            <span class="mobile-detail-label">Price Level 3</span>
                            <span class="mobile-detail-value">$<%= item.priceLevel3 ? item.priceLevel3.toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="mobile-actions">
                            <a href="/admin/edit-inventory/<%= item.id %>" class="btn-edit">Edit</a>
                            <a href="/admin/delete-inventory/<%= item.id %>" class="btn-delete" onclick="return confirm('Delete this item?');">Delete</a>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    </div>

    <script>
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            // Desktop table rows
            document.querySelectorAll('.inventory-item').forEach(row => {
                const name = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                row.style.display = name.includes(searchTerm) ? '' : 'none';
            });
            
            // Mobile cards
            document.querySelectorAll('.mobile-card').forEach(card => {
                const name = card.querySelector('.mobile-card-name').textContent.toLowerCase();
                card.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        });
        
        // Mobile card expand/collapse
        document.querySelectorAll('.mobile-card-header').forEach(header => {
            header.addEventListener('click', () => {
                header.closest('.mobile-card').classList.toggle('expanded');
            });
        });
        
        // Inline quantity editing
        document.querySelectorAll('.qty-input').forEach(input => {
            let originalValue = input.value;
            
            input.addEventListener('focus', () => {
                originalValue = input.value;
            });
            
            input.addEventListener('blur', () => {
                if (input.value !== originalValue) {
                    saveQuantity(input);
                }
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        });
        
        function saveQuantity(input) {
            const id = input.dataset.id;
            const quantity = input.value;
            
            input.classList.add('saving');
            input.classList.remove('saved');
            
            fetch('/admin/update-inventory-quantity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, quantity })
            })
            .then(res => res.json())
            .then(data => {
                input.classList.remove('saving');
                if (data.success) {
                    input.classList.add('saved');
                    input.value = data.quantity;
                    
                    // Also update the other input (mobile/desktop) if exists
                    document.querySelectorAll('.qty-input[data-id="' + id + '"]').forEach(otherInput => {
                        if (otherInput !== input) {
                            otherInput.value = data.quantity;
                        }
                    });
                    
                    setTimeout(() => input.classList.remove('saved'), 1500);
                } else {
                    alert('Failed to update quantity');
                }
            })
            .catch(err => {
                input.classList.remove('saving');
                alert('Error saving quantity');
            });
        }
        
        // Drag and drop using handle only
        let draggedRow = null;
        
        document.querySelectorAll('.drag-handle').forEach(handle => {
            handle.addEventListener('dragstart', function(e) {
                draggedRow = this.closest('.inventory-item');
                draggedRow.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedRow.dataset.id);
            });
            
            handle.addEventListener('dragend', function(e) {
                if (draggedRow) {
                    draggedRow.classList.remove('dragging');
                }
                document.querySelectorAll('.inventory-item').forEach(row => {
                    row.classList.remove('drag-over');
                });
                draggedRow = null;
            });
        });
        
        document.querySelectorAll('.inventory-item').forEach(row => {
            row.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (draggedRow && draggedRow !== this) {
                    this.classList.add('drag-over');
                }
            });
            
            row.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            
            row.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                if (draggedRow && draggedRow !== this) {
                    const dropTargetCategory = this.dataset.category;
                    const draggedItemCategory = draggedRow.dataset.category;
                    
                    if (dropTargetCategory === draggedItemCategory) {
                        // Insert dragged row after drop target
                        this.parentNode.insertBefore(draggedRow, this.nextSibling);
                        saveNewOrder();
                    } else {
                        alert('Items can only be reordered within the same category.');
                    }
                }
            });
        });
        
        function saveNewOrder() {
            const items = Array.from(document.querySelectorAll('.inventory-item')).map((item, index) => ({
                id: item.dataset.id,
                rank: index + 1
            }));
            
            fetch('/admin/update-inventory-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(items)
            });
        }
    </script>
</body>
</html>
